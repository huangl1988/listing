<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pfq.deal.trans_listing.dao.IShopDao">
	
	<sql id="shop_details">
			shop_name AS shopName,
			shop_code AS shopCode,
			shop_address AS shopAddres,
			start_time AS startTime,
			end_time AS endTime,
			point,
			region_id AS regionId,
			id,
			inserttime  AS  inserttime
	</sql>
	
	<insert id="insert" keyProperty="id" parameterType="com.pfq.deal.trans_listing.dto.ShopDto">
		INSERT INTO tb_shop(
			shop_name,
			shop_code,
			shop_address,
			start_time,
			end_time,
			point,
			region_id
		)
		VALUES(
			#{shopName},
			#{shopCode},
			#{shopAddres},
			#{startTime},
			#{endTime},
			#{point},
			#{regionId}
		) 
	</insert>
	
	<update id="update" parameterType="com.pfq.deal.trans_listing.dto.CommodyDTO">
		UPDATE tb_shop
		SET
		<if test="shopName!=null">
			shop_name=#{shopName},
		</if>
		<if test="shopCode!=null">
			shop_code=#{shopCode},
		</if>
		<if test="shopAddres!=null">
			shop_address=#{shopAddres},
		</if>
		<if test="startTime!=null">
			start_time=#{startTime},
		</if>
		<if test="endTime!=null">
			end_time=#{endTime},
		</if>
		<if test="point!=null">
			point=#{point},
		</if>
		 updatetime=now()
		 WHERE 
		 	id=#{id}
	</update>
	
	<delete id="delete">
		DELETE FROM tb_shop WHERE id=#{shopId} AND NOT EXISTS (
	SELECT
		1
	FROM
		tb_shop_commody WHERE tb_shop_commody.shop_id = tb_shop.id
	)
	</delete>
	
	<select id="select" resultType="com.pfq.deal.trans_listing.dto.ShopDto">
		SELECT	
			<include refid="shop_details"/>
		 FROM  tb_shop
		 WHERE
		 	id=#{shopId}
	</select>
	
	<select id="selectList" resultType="com.pfq.deal.trans_listing.dto.ShopDto">
		SELECT	
			<include refid="shop_details"/>
		 FROM  tb_shop
		 WHERE
			1=1 AND region_id=#{region}
	</select>
	<insert id="saveStyleCommodyRelation">
		INSERT INTO tb_shop_style_commody(
			shop_id,
			style_id,
			commody_id
		  )
		VALUES
		 <foreach collection="commodyList" index="index" item="item" separator=",">
			 (#{shopId},#{styleId},#{item})
		 </foreach>
	</insert>
	<insert id="saveStyle">
		INSERT INTO tb_shop_style(
			style_id,
			shop_id
		)
		VALUES (
			#{styleId},
			#{shopId}
		)
	</insert>
	<select id="selectStyleExist" resultType="Integer">
		SELECT count(1) FROM tb_shop_style WHERE 1=1
		<if test="shopId!=null">
			AND shop_id=#{shopId}
		</if>
		<if test="styleId!=null">
			AND style_id=#{styleId}
		</if>
	</select>

	<delete id="deleteStyle">
		DELETE  FROM  tb_shop_style WHERE 1=1
		<if test="shopId!=null">
			AND shop_id=#{shopId}
		</if>
		<if test="styleId!=null">
			AND style_id=#{styleId}
		</if>
	</delete>
	<delete id="deleteStyleCommody">
		DELETE FROM tb_shop_style_commody WHERE 1=1
		<if test="shopId!=null">
			AND shop_id=#{shopId}
		</if>
		<if test="styleId!=null">
			AND style_id=#{styleId}
		</if>
		<if test="commodyId!=null">
			AND commody_id=#{commodyId}
		</if>
	</delete>
	<select id="existCommodyInShop" resultType="Integer">
		SELECT
			COUNT(1)
		FROM tb_shop_commody WHERE 1=1
		<if test="shopId!=null">
			AND shop_id =#{shopId}
		</if>
		<if test="commodyId!=null">
			AND commody_id=#{commodyId}
		</if>
	</select>
	<insert id="saveShopCommody" parameterType="com.pfq.deal.trans_listing.dto.ShopCommodyDto">
		INSERT INTO tb_shop_commody(
			shop_id,
			commody_id,
			show_time,
			show_flag,
			picture_url,
		  	shop_price
		)VALUES (#{shop_id},#{commody_id},#{showTime},#{show_flag},#{picture_url},#{show_price})
	</insert>
	<insert id="saveTagCommodyRef">
		INSERT INTO tb_shop_commody_tag(
		shop_id,
		tag_id,
		commody_id
		)
		VALUES
		<foreach collection="commodyList" index="index" item="item" separator=",">
			(#{shopId},#{item.id},#{commdoyId})
		</foreach>
	</insert>
	<delete id="deleteTagRef">
		DELETE FROM  tb_shop_commody_tag WHERE 1=1
		<if test="shopId!=null">
			AND shop_id=#{shopId}
		</if>
		<if test="commodyId!=null">
			AND commody_id=#{commodyId}
		</if>
		<if test="tagId!=null">
			AND tag_id=#{tagId}
		</if>
	</delete>
	<update id="updateCommodyInfo" parameterType="com.pfq.deal.trans_listing.dto.ShopCommodyDto">
		UPDATE tb_shop_commody
			SET
			<if test="showTime!=null">
				show_time=#{showTime},
			</if>
			<if test="show_flag!=null">
				show_flag=#{show_flag},
			</if>
			<if test="picture_url!=null">
				picture_url=#{picture_url},
			</if>
			<if test="show_price!=null">
				show_price=#{show_price},
			</if>
			updatetime=now(),
		WHERE shop_id=#{shop_id} AND commody_id=#{commody_id}
	</update>
	<delete id="deleteCommody">
		DELETE FROM  tb_shop_commody WHERE 1=1
		<if test="shopId!=null">
			AND shop_id=#{shopId}
		</if>
		<if test="commodyId!=null">
			AND commody_id=#{commodyId}
		</if>
	</delete>
	<select id="getTagRef" resultType="Long">
		SELECT tag_id FROM  tb_shop_commody_tag WHERE 1=1
		<if test="shopId!=null">
			AND shop_id=#{shopId}
		</if>
		<if test="commodyId!=null">
			AND commody_id=#{commodyId}
		</if>
	</select>
	<select id="getShopCommodyByCommodyId" resultType="com.pfq.deal.trans_listing.dto.ShopCommodyDto">
		SELECT
			shop_id,
			commody_id,
			show_time AS showTime,
			show_flag,
			picture_url,
		  	shop_price,
		  	updatetime
		FROM
		 	tb_shop_commody
		 WHERE commody_id=#{commodyId}
	</select>
	<select id="getStyleCommodyRef" resultType="Long">
		SELECT commody_id FROM tb_shop_style_commody WHERE 1=1
		<if test="shopId!=null">
		AND shop_id=#{shopId}
		</if>
		<if test="styleId!=null">
			AND style_id=#{styleId}
		</if>
	</select>
</mapper>