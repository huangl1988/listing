<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.pfq.deal.trans_listing.dao.IOrderDao">
	
	<sql id="order_details">
			id,
			commody_id AS commodyId,
			commody_price AS commodyPrice,
			`number`,
			tags_name AS tagsName,
			site_no AS siteNo,
			total_id AS totalId,
			order_no AS orderNo,
			cancel_flag AS cancelFlag,
			cancel_time AS cancelTime,
			is_cooking AS isCooking,
			inserttime AS inserttime
	</sql>
	
	<sql id="order_total">
			id,
			site_no AS siteNo,
			total_price AS totalPrice,
			order_num AS orderNum,
			order_time AS orderTime,
			inserttime AS inserttime,
			updatetime,
			order_no AS orderNo,
			on_line_flag AS onLineFlag,
			address AS address,
			point AS point,
			confirm_flag AS confirmFlag,
			confirm_date AS confirmDate,
			shop_id AS shopId
	</sql>
	
	<insert id="save" keyProperty="id" keyColumn="id" useGeneratedKeys="true" parameterType="com.pfq.deal.trans_listing.dto.OrderTotalDTO">
		INSERT INTO tb_order_total(
		site_no,
		total_price,
		order_num,
		order_time,
		order_no,
		on_line_flag,
		address,
		point,
		shop_id,
		confirm_flag
		)
		(SELECT
			#{siteNo},
			#{totalPrice},
			#{orderNum},
		  	Now(),
		  	#{orderNo},
		  	0,
		  	#{address},
		  	#{point},
		  	#{shopId},
		  	0
		FROM tb_order_details WHERE  not exists(SELECT 1 FROM  tb_pay_order WHERE  site_no=#{siteNo} AND shop_id=#{shopId} AND status &lt;20) limit 1)
	</insert>
	
	<insert id="saveDetails" parameterType="com.pfq.deal.trans_listing.dto.OrderDetailsInfoDTO">
		INSERT INTO tb_order_details(
		commody_id,
		commody_price,
		number,
		tags_name,
		site_no,
		total_id,
		order_no,
		cancel_flag,
		cancel_time,
		is_cooking
		)
		VALUES(
		#{commodyId},
		#{commodyPrice},
		#{number},
		#{tagsName},
		#{siteNo},
		#{totalId},
		#{orderNo},
		0,
		NULL,
		0
		)
	</insert>
	
	<select id="findOrderNoBySiteNo" resultType="com.pfq.deal.trans_listing.dto.OrderTotalDTO">
		SELECT <include refid="order_total"/> FROM tb_order_total where site_no=#{siteNo} AND shop_id=#{shopId} order by inserttime desc limit 1
	</select>
	
	<select id="getTotalList" resultType="com.pfq.deal.trans_listing.dto.OrderTotalDTO">
		SELECT <include refid="order_total"/> FROM tb_order_total where order_no =#{orderNo} order by inserttime desc
	</select>
	
	<select id="getOrderList" resultType="com.pfq.deal.trans_listing.dto.OrderDetailsInfoDTO">
		SELECT	
			<include refid="order_details"/>
		 FROM  tb_order_details
		 WHERE
		 	order_no=#{orderNo} AND  cancel_flag=0 AND  `number`>0
	</select>
	
	<update id="updateDetails">
		UPDATE
			tb_order_details
		SET
			<if test="dto.commodyPrice!=null">
				commody_price =#{dto.commodyPrice},
			</if>
			<if test="dto.number!=null">
				`number`=#{dto.number},
			</if>
			<if test="dto.tagsName!=null">
				tags_name=#{dto.tagsName},
			</if>
			<if test="dto.cancelFlag!=null and dto.cancelFlag==1">
				cancel_flag=1,
				cancel_time=now(),
			</if>
			updatetime=now()
		WHERE
			order_no=#{orderNo} AND id=#{dto.id} AND is_cooking=0
	</update>

	<update id="updateTotal">
		UPDATE
			tb_order_total
		SET
			total_price=(SELECT sum(commody_price * `number`) FROM tb_order_details WHERE total_id=id)),
			order_num=(SELECT sum(`number`) FROM tb_order_details WHERE total_id=id)),
			updatetime=now(),
		WHERE
			order_no=#{orderNo}
	</update>

	<delete id="deleteOrder">
		DELETE FROM tb_order_total
		WHERE order_no=#{orderNo} AND id=#{totalId}
	</delete>

	<delete id="deleteOrderDetails">
		DELETE FROM tb_order_details
		WHERE order_no=#{orderNo} AND total_id=#{totalId}
	</delete>

	<update id="confirmOrder">
		UPDATE
			tb_order_total
		SET
			confirm_flag=1,
			confirm_date=now(),
			updatetime=now()
		WHERE
			order_no=#{orderNo}
		<if test="totalId!=null">
			AND id = #{totalId}
		</if>
	</update>
	<insert id="createPaymentOrder" parameterType="java.util.Map">
		INSERT INTO tb_pay_order(
			order_no,
			price_total,
			shop_id,
			site_no,
			status
		)VALUES (
		#{orderNo},
		#{totalPrice},
		#{shopId},
		#{siteNo},
		#{status}
		)
	</insert>
	<update id="confirmPayOrder">
		UPDATE
			tb_pay_order
		SET status=20
		WHERE
			order_no=#{orderNo}
	</update>

	<update id="confirmCooking">
		UPDATE
			tb_order_details
		SET
			is_cooking=1
		WHERE
			id=#{id} AND  number=#{num} AND  cancel_flag=0
	</update>

	<select id="getUncookingOrder" resultType="com.pfq.deal.trans_listing.dto.OrderDetailsInfoDTO">

		SELECT
		<include refid="order_details"/>
		FROM  tb_order_details
		INNER JOIN  tb_order_total ON tb_order_details.total_id=tb_order_total.id AND shop_id=#{shopId}
		WHERE
			cancel_flag=0 AND  `number`>0 ORDER BY tb_order_details.commody_id ASC ,tb_order_details.inserttime ASC
	</select>

	<select id="getPayStatus" resultType="Integer">
		SELECT status FROM tb_pay_order 
		WHERE
			order_no=#{orderNo}
	</select>
	
	<select id="listOrderNo" resultType="String">
		SELECT order_no FROM tb_order_total order by inserttime desc
	</select>
</mapper>